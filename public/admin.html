<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .user-card { border: 1px solid #ccc; padding: 10px; margin: 5px; border-radius: 6px; }
    .pending { background: #fff3cd; }
    .approved { background: #d4edda; }
    .blocked { background: #f8d7da; }
    button { margin: 2px; }
  </style>
</head>
<body>

  <!-- Login -->
  <div id="login">
    <h2>Admin Login</h2>
    <input id="username" placeholder="Username"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <p id="loginMsg"></p>
  </div>

  <!-- Panel -->
  <div id="panel" class="hidden">
    <h2>Admin Panel</h2>
    <button onclick="logout()">Logout</button>
    <h3>Pending Users</h3>
    <div id="pending"></div>
    <h3>Approved Users</h3>
    <div id="approved"></div>
    <h3>Blocked Users</h3>
    <div id="blocked"></div>
  </div>

<script>
  const API = (path, body, method="POST") => {
    const token = localStorage.getItem("token");
    return fetch(path, {
      method,
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: body ? JSON.stringify(body) : undefined
    }).then(r => r.json());
  };

  async function login() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    const res = await fetch("/admin/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    }).then(r => r.json());

    if (res.ok) {
      localStorage.setItem("token", res.token);
      document.getElementById("login").classList.add("hidden");
      document.getElementById("panel").classList.remove("hidden");
      loadUsers();
    } else {
      document.getElementById("loginMsg").innerText = res.message || "Login failed";
    }
  }

  function logout() {
    localStorage.removeItem("token");
    document.getElementById("panel").classList.add("hidden");
    document.getElementById("login").classList.remove("hidden");
  }

  async function loadUsers() {
    const res = await API("/admin/users", null, "GET");
    if (!res) return alert("Failed to load users");

    const pendingDiv = document.getElementById("pending");
    const approvedDiv = document.getElementById("approved");
    const blockedDiv = document.getElementById("blocked");
    pendingDiv.innerHTML = approvedDiv.innerHTML = blockedDiv.innerHTML = "";

    Object.values(res).forEach(u => {
      const div = document.createElement("div");
      div.className = "user-card " + u.status;
      div.innerHTML = `
        <b>${u.sessionId}</b><br>
        Status: ${u.status}<br>
        Expiry: ${u.expiry ? new Date(u.expiry).toLocaleString() : "Lifetime"}<br>
        Notes: ${u.notes || ""}<br>
        <button onclick="approve('${u.sessionId}')">Approve</button>
        <button onclick="lifetime('${u.sessionId}')">Lifetime</button>
        <button onclick="setExpiry('${u.sessionId}')">Set Expiry</button>
        <button onclick="block('${u.sessionId}')">Block</button>
        <button onclick="unblock('${u.sessionId}')">Unblock</button>
      `;

      if (u.status === "pending") pendingDiv.appendChild(div);
      else if (u.status === "approved" && !u.blocked) approvedDiv.appendChild(div);
      else if (u.status === "blocked" || u.blocked) blockedDiv.appendChild(div);
    });
  }

  async function approve(username) {
    const res = await API("/admin/approve", { username });
    alert("Approved: " + username);
    loadUsers();
  }

  async function lifetime(username) {
    const res = await API("/admin/approve", { username, expiry: null });
    alert("Lifetime access: " + username);
    loadUsers();
  }

  async function setExpiry(username) {
    const days = prompt("Enter days until expiry:");
    if (!days) return;
    const expiry = Date.now() + (parseInt(days) * 24 * 60 * 60 * 1000);
    const res = await API("/admin/expire", { username, expiry });
    alert("Expiry updated: " + username);
    loadUsers();
  }

  async function block(username) {
    const res = await API("/admin/block", { username });
    alert("Blocked: " + username);
    loadUsers();
  }

  async function unblock(username) {
    const res = await API("/admin/unblock", { username });
    alert("Unblocked: " + username);
    loadUsers();
  }

  // Auto-login if token exists
  if (localStorage.getItem("token")) {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("panel").classList.remove("hidden");
    loadUsers();
  }
</script>
</body>
</html>
