<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Facebook Auto Comment Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f6fa; color:#333; }
    header { background:#2c3e50; color:#fff; padding:15px; font-size:20px; text-align:center; }
    .container { max-width:1100px; margin:20px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h2 { margin-top:0; }
    .login-box { max-width:350px; margin:80px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    .login-box h2 { text-align:center; margin-bottom:20px; }
    input[type=text], input[type=password], select {
      width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:5px;
    }
    button {
      padding:8px 14px; border:none; border-radius:5px; cursor:pointer;
      margin:3px; font-size:14px;
    }
    button.primary { background:#3498db; color:#fff; }
    button.danger { background:#e74c3c; color:#fff; }
    button.success { background:#27ae60; color:#fff; }
    button.warning { background:#f39c12; color:#fff; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    table th, table td { padding:8px; border:1px solid #ddd; text-align:center; }
    table th { background:#f0f0f0; }
    .actions button { padding:5px 8px; font-size:12px; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .top-bar input { max-width:200px; }
  </style>
</head>
<body>
  <header>Admin Panel - Facebook Auto Comment Tool (Pro)</header>

  <!-- Login Box -->
  <div id="loginBox" class="login-box" style="display:none;">
    <h2>Admin Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button class="primary" onclick="login()">Sign In</button>
    <p id="loginMsg" style="color:red;text-align:center;"></p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="container" style="display:none;">
    <div class="top-bar">
      <h2>User Management</h2>
      <div>
        <input type="text" id="searchBox" placeholder="Search by ID / Status">
        <button class="primary" onclick="loadUsers()">Refresh</button>
        <button class="danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <div>
      <label>Approve with Expiry:
        <select id="expirySelect">
          <option value="">Lifetime</option>
          <option value="1d">1 Day</option>
          <option value="7d">7 Days</option>
          <option value="30d">30 Days</option>
        </select>
      </label>
      <button class="success" onclick="bulkAction('approve')">Approve</button>
      <button class="warning" onclick="bulkAction('block')">Block</button>
      <button onclick="bulkAction('unblock')">Unblock</button>
      <button onclick="bulkExpiry()">Set Expiry</button>
      <button class="danger" onclick="bulkAction('delete')">Delete</button>
    </div>

    <table id="userTable">
      <thead>
        <tr>
          <th><input type="checkbox" onclick="toggleAll(this)"></th>
          <th>Session ID</th>
          <th>Status</th>
          <th>Blocked</th>
          <th>Expiry</th>
          <th>Approved At</th>
          <th>Updated</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="userCount"></p>
  </div>

  <script>
    async function checkAuth() {
      const res = await fetch("/api/checkAuth");
      const data = await res.json();
      if(data.authenticated){
        document.getElementById("loginBox").style.display="none";
        document.getElementById("dashboard").style.display="block";
        loadUsers();
      } else {
        document.getElementById("loginBox").style.display="block";
        document.getElementById("dashboard").style.display="none";
      }
    }

    async function login(){
      const username=document.getElementById("username").value;
      const password=document.getElementById("password").value;
      const res=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password})});
      const data=await res.json();
      if(data.success){ checkAuth(); } else { document.getElementById("loginMsg").innerText="Invalid login"; }
    }

    async function logout(){
      await fetch("/api/logout");
      checkAuth();
    }

    async function loadUsers(){
      const q=document.getElementById("searchBox").value;
      const res=await fetch("/api/users?q="+encodeURIComponent(q));
      const users=await res.json();
      const tbody=document.querySelector("#userTable tbody");
      tbody.innerHTML="";
      users.forEach(u=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><input type="checkbox" value="${u.id}"></td>
          <td>${u.id}</td>
          <td>${u.status}</td>
          <td>${u.blocked}</td>
          <td>${u.expiry || "-"}</td>
          <td>${u.approvedAt || "-"}</td>
          <td>${u.updated || "-"}</td>
          <td class="actions">
            <button class="success" onclick="updateUser('${u.id}','approved')">Approve</button>
            <button class="warning" onclick="updateUser('${u.id}','blocked')">Block</button>
            <button onclick="updateUser('${u.id}','unblocked')">Unblock</button>
            <button onclick="setExpiry('${u.id}')">Set Expiry</button>
            <button class="danger" onclick="updateUser('${u.id}','delete')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("userCount").innerText="Loaded "+users.length+" user(s)";
    }

    async function updateUser(id, action){
      const body={id};
      if(action==="approved"){
        body.status="approved";
        const expiry=document.getElementById("expirySelect").value;
        if(expiry) body.expiry=expiry;
      }
      if(action==="blocked"){ body.status="blocked"; }
      if(action==="unblocked"){ body.status="approved"; }
      if(action==="delete"){ body.delete=true; }
      await fetch("/api/users/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
      loadUsers();
    }

    async function setExpiry(id){
      const expiry=prompt("Enter expiry date (YYYY-MM-DD):");
      if(!expiry)return;
      await fetch("/api/users/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,expiry})});
      loadUsers();
    }

    function toggleAll(cb){
      document.querySelectorAll("#userTable tbody input[type=checkbox]").forEach(c=>c.checked=cb.checked);
    }

    function getSelectedIds(){
      return Array.from(document.querySelectorAll("#userTable tbody input[type=checkbox]:checked")).map(c=>c.value);
    }

    function bulkAction(action){
      const ids=getSelectedIds();
      ids.forEach(id=>updateUser(id,action));
    }

    function bulkExpiry(){
      const ids=getSelectedIds();
      const expiry=prompt("Enter expiry date (YYYY-MM-DD):");
      if(!expiry)return;
      ids.forEach(id=>fetch("/api/users/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,expiry})}));
      loadUsers();
    }

    checkAuth();
  </script>
</body>
</html>
