<!-- public/admin.html -->
<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-4 md:p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl md:text-3xl font-bold">Admin Panel</h1>
      <div id="loginState" class="text-sm text-slate-600"></div>
    </header>

    <!-- Login Card -->
    <section id="loginCard" class="bg-white rounded-2xl shadow p-5 max-w-md mx-auto">
      <h2 class="text-lg font-semibold mb-3">Admin Login</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Username</label>
          <input id="username" class="w-full border rounded-lg px-3 py-2" placeholder="admin" />
        </div>
        <div>
          <label class="block text-sm mb-1">Password</label>
          <input id="password" type="password" class="w-full border rounded-lg px-3 py-2" placeholder="••••••••" />
        </div>
        <button id="btnLogin" class="w-full bg-black text-white rounded-xl py-2 font-medium">Sign in</button>
        <p class="text-xs text-slate-500">
          নোট: পাসওয়ার্ডটা আপনার সার্ভারে যে hash বসিয়েছেন, সেটার আসল পাসওয়ার্ড।
        </p>
        <div id="loginMsg" class="text-sm text-rose-600"></div>
      </div>
    </section>

    <!-- App -->
    <section id="app" class="hidden">
      <!-- Actions / Add user -->
      <div class="bg-white rounded-2xl shadow p-5 mb-6">
        <h2 class="text-lg font-semibold mb-4">Add / Approve User</h2>
        <div class="grid md:grid-cols-5 gap-3">
          <input id="newUser" class="border rounded-lg px-3 py-2 md:col-span-2" placeholder="username (session/user)" />
          <input id="newExpiry" type="datetime-local" class="border rounded-lg px-3 py-2" />
          <button id="btnApproveLifetime" class="bg-emerald-600 text-white rounded-xl px-4 py-2">Approve (Lifetime)</button>
          <button id="btnApproveExpiry" class="bg-blue-600 text-white rounded-xl px-4 py-2">Approve with Expiry</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Expiry ফাঁকা থাকলে লাইফটাইম ধরা হবে।</p>
      </div>

      <!-- Tabs -->
      <div class="flex items-center gap-2 mb-3">
        <button data-tab="approved" class="tab-btn bg-black text-white rounded-xl px-4 py-2 text-sm">Approved</button>
        <button data-tab="blocked" class="tab-btn rounded-xl px-4 py-2 text-sm border">Blocked</button>
        <div class="ml-auto">
          <input id="search" class="border rounded-lg px-3 py-2" placeholder="Search username…" />
        </div>
      </div>

      <!-- Tables -->
      <div id="wrapApproved" class="tab-pane">
        <div class="bg-white rounded-2xl shadow overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-slate-700">
              <tr>
                <th class="text-left px-4 py-3">Username</th>
                <th class="text-left px-4 py-3">Approved At</th>
                <th class="text-left px-4 py-3">Expiry</th>
                <th class="text-left px-4 py-3">Status</th>
                <th class="text-left px-4 py-3">Actions</th>
              </tr>
            </thead>
            <tbody id="tbodyApproved"></tbody>
          </table>
        </div>
      </div>

      <div id="wrapBlocked" class="tab-pane hidden">
        <div class="bg-white rounded-2xl shadow overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-slate-700">
              <tr>
                <th class="text-left px-4 py-3">Username</th>
                <th class="text-left px-4 py-3">Approved At</th>
                <th class="text-left px-4 py-3">Expiry</th>
                <th class="text-left px-4 py-3">Status</th>
                <th class="text-left px-4 py-3">Actions</th>
              </tr>
            </thead>
            <tbody id="tbodyBlocked"></tbody>
          </table>
        </div>
      </div>

      <div id="toast" class="fixed bottom-4 right-4 bg-black text-white rounded-xl px-4 py-2 text-sm hidden"></div>
    </section>
  </div>

<script>
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
const API = {
  login: "/admin/login",
  users: "/admin/users",
  approve: "/admin/approve",
  block: "/admin/block",
  unblock: "/admin/unblock",
  expire: "/admin/expire",
};
let TOKEN = localStorage.getItem("admin_token") || "";

function showToast(msg) {
  const t = $("#toast");
  t.textContent = msg;
  t.classList.remove("hidden");
  setTimeout(() => t.classList.add("hidden"), 1600);
}

function setAuthedUI(authed) {
  if (authed) {
    $("#loginCard").classList.add("hidden");
    $("#app").classList.remove("hidden");
    $("#loginState").textContent = "Logged in";
  } else {
    $("#loginCard").classList.remove("hidden");
    $("#app").classList.add("hidden");
    $("#loginState").textContent = "";
  }
}

async function api(path, opts = {}) {
  const headers = opts.headers || {};
  if (TOKEN) headers["Authorization"] = "Bearer " + TOKEN;
  if (!(opts.body instanceof FormData)) headers["Content-Type"] = "application/json";
  const res = await fetch(path, {
    method: opts.method || "GET",
    headers,
    body: opts.body ? (opts.body instanceof FormData ? opts.body : JSON.stringify(opts.body)) : undefined,
  });
  if (res.status === 401) {
    setAuthedUI(false);
    throw new Error("Unauthorized");
  }
  return res.json();
}

function isoOrNull(dtValue) {
  if (!dtValue) return null;
  const d = new Date(dtValue);
  if (isNaN(d.getTime())) return null;
  return d.toISOString();
}

function humanDate(v) {
  if (!v) return "Lifetime";
  const d = new Date(v);
  if (isNaN(d.getTime())) return v;
  return d.toLocaleString();
}

function isExpired(expiry) {
  if (!expiry) return false;
  return new Date(expiry).getTime() <= Date.now();
}

function filterUsers(list, { blocked }) {
  return list.filter(u => !!u.blocked === !!blocked);
}

function renderRows(list, tbodyEl) {
  const q = ($("#search").value || "").toLowerCase();
  tbodyEl.innerHTML = "";
  list
    .filter(u => !q || (u.username || "").toLowerCase().includes(q))
    .forEach(u => {
      const tr = document.createElement("tr");
      tr.className = "border-t";
      tr.innerHTML = `
        <td class="px-4 py-3 font-medium">${u.username || "-"}</td>
        <td class="px-4 py-3">${u.approvedAt ? humanDate(u.approvedAt) : "-"}</td>
        <td class="px-4 py-3">${humanDate(u.expiry)}</td>
        <td class="px-4 py-3">
          ${u.blocked ? '<span class="text-rose-600 font-medium">Blocked</span>'
                       : (isExpired(u.expiry) ? '<span class="text-amber-600 font-medium">Expired</span>'
                                              : '<span class="text-emerald-600 font-medium">Active</span>')}
        </td>
        <td class="px-4 py-3">
          <div class="flex flex-wrap gap-2">
            ${u.blocked
              ? `<button data-act="unblock" data-user="${u.username}" class="px-3 py-1 rounded-lg border">Unblock</button>`
              : `<button data-act="block" data-user="${u.username}" class="px-3 py-1 rounded-lg border">Block</button>`}
            <button data-act="lifetime" data-user="${u.username}" class="px-3 py-1 rounded-lg border">Set Lifetime</button>
            <button data-act="set-exp" data-user="${u.username}" class="px-3 py-1 rounded-lg border">Set Expiry…</button>
          </div>
        </td>`;
      tbodyEl.appendChild(tr);
    });

  // wire actions
  tbodyEl.querySelectorAll("button[data-act]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const user = btn.dataset.user;
      try {
        if (btn.dataset.act === "block") {
          await api(API.block, { method: "POST", body: { username: user }});
          showToast("Blocked");
        } else if (btn.dataset.act === "unblock") {
          await api(API.unblock, { method: "POST", body: { username: user }});
          showToast("Unblocked");
        } else if (btn.dataset.act === "lifetime") {
          await api(API.approve, { method: "POST", body: { username: user, expiry: null }});
          showToast("Lifetime set");
        } else if (btn.dataset.act === "set-exp") {
          const inp = prompt("Pick expiry (YYYY-MM-DD HH:mm), empty for lifetime", "");
          const parsed = inp ? new Date(inp.replace(" ", "T")) : null;
          const expISO = parsed && !isNaN(parsed.getTime()) ? parsed.toISOString() : null;
          await api(API.expire, { method: "POST", body: { username: user, expiry: expISO }});
          showToast("Expiry updated");
        }
        await loadUsers();
      } catch (e) {
        showToast(e.message || "Action failed");
      }
    });
  });
}

async function loadUsers() {
  const data = await api(API.users);
  // server.js -> res.json(usersManager.loadUsers()) => array of users
  const list = Array.isArray(data) ? data
              : (Array.isArray(data?.users) ? data.users : []);
  const approved = filterUsers(list, { blocked: false });
  const blocked = filterUsers(list, { blocked: true });
  renderRows(approved, $("#tbodyApproved"));
  renderRows(blocked, $("#tbodyBlocked"));
}

function wireTabs() {
  $$(".tab-btn").forEach(b => {
    b.addEventListener("click", () => {
      $$(".tab-btn").forEach(x => x.classList.remove("bg-black","text-white"));
      b.classList.add("bg-black","text-white");
      const tab = b.dataset.tab;
      $("#wrapApproved").classList.toggle("hidden", tab !== "approved");
      $("#wrapBlocked").classList.toggle("hidden", tab !== "blocked");
    });
  });
}

async function doLogin() {
  $("#loginMsg").textContent = "";
  const username = $("#username").value.trim();
  const password = $("#password").value;
  try {
    const res = await fetch(API.login, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    }).then(r => r.json());
    if (!res.ok || !res.token) {
      $("#loginMsg").textContent = res.message || "Login failed";
      return;
    }
    TOKEN = res.token;
    localStorage.setItem("admin_token", TOKEN);
    setAuthedUI(true);
    await loadUsers();
    showToast("Logged in");
  } catch (e) {
    $("#loginMsg").textContent = e.message || "Login failed";
  }
}

function wireLogin() {
  $("#btnLogin").addEventListener("click", doLogin);
}

function wireAddUser() {
  $("#btnApproveLifetime").addEventListener("click", async () => {
    const u = $("#newUser").value.trim();
    if (!u) return showToast("Username required");
    try {
      await api(API.approve, { method: "POST", body: { username: u, expiry: null }});
      $("#newUser").value = "";
      $("#newExpiry").value = "";
      showToast("Approved (lifetime)");
      await loadUsers();
    } catch (e) {
      showToast(e.message || "Failed");
    }
  });
  $("#btnApproveExpiry").addEventListener("click", async () => {
    const u = $("#newUser").value.trim();
    const ex = isoOrNull($("#newExpiry").value);
    if (!u) return showToast("Username required");
    try {
      await api(API.approve, { method: "POST", body: { username: u, expiry: ex }});
      $("#newUser").value = "";
      $("#newExpiry").value = "";
      showToast("Approved with expiry");
      await loadUsers();
    } catch (e) {
      showToast(e.message || "Failed");
    }
  });
}

function wireSearch() {
  $("#search").addEventListener("input", () => loadUsers());
}

async function init() {
  wireLogin();
  wireTabs();
  wireAddUser();
  wireSearch();

  if (TOKEN) {
    try {
      setAuthedUI(true);
      await loadUsers();
    } catch {
      setAuthedUI(false);
      localStorage.removeItem("admin_token");
      TOKEN = "";
    }
  }
}
init();
</script>
</body>
</html>
