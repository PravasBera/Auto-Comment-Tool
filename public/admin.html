
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin Panel — Facebook Auto Comment Tool (Pro)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --panel:#111827;     /* gray-900 */
      --muted:#1f2937;     /* gray-800 */
      --text:#e5e7eb;      /* gray-200 */
      --text-dim:#9ca3af;  /* gray-400 */
      --accent:#22d3ee;    /* cyan-400 */
      --accent-2:#34d399;  /* emerald-400 */
      --warn:#f59e0b;      /* amber-500 */
      --err:#ef4444;       /* red-500 */
      --ok:#10b981;        /* green-500 */
      --card:#0b1220;
      --border:#243244;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0b1220,#0f172a 40%,#0b1220);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .card{
      background: radial-gradient(1200px 600px at 10% -20%, #0c1330 0%, rgba(12,19,48,0) 60%) , var(--panel);
      border:1px solid var(--border); border-radius:18px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex; gap:16px; flex-wrap:wrap}
    .col{flex:1 1 300px}
    h1{margin:0 0 10px; font-size:26px; letter-spacing:.3px}
    h2{margin:0 0 12px; font-size:18px; color:var(--text-dim); font-weight:600}
    .muted{color:var(--text-dim)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#0a1322;color:var(--text-dim);font-size:12px}
    .btn{
      appearance:none; border:1px solid var(--border); background:linear-gradient(180deg,#121a2d,#0b1220);
      color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
      transition:.15s transform ease,.2s background ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn-primary{border-color:#155e75; background:linear-gradient(180deg,#0c2d35,#0b1220); color:#a5f3fc}
    .btn-ok{border-color:#14532d; color:#bbf7d0}
    .btn-warn{border-color:#7c2d12; color:#fed7aa}
    .btn-err{border-color:#7f1d1d; color:#fecaca}
    .btn-ghost{background:transparent}
    .input, select{
      width:100%; border:1px solid var(--border); background:#0b1220; color:var(--text);
      padding:10px 12px; border-radius:12px; outline:none;
    }
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    table{width:100%; border-collapse:collapse; margin-top:12px; overflow:hidden; border-radius:12px; border:1px solid var(--border)}
    th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:middle; font-size:14px}
    th{background:#0a1322; color:#cbd5e1; position:sticky; top:0; z-index:1}
    tr:hover td{background:#0b1628}
    .tag{padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .tag.ok{background:#072418;color:#86efac;border-color:#14532d}
    .tag.block{background:#2a0b0b;color:#fecaca;border-color:#7f1d1d}
    .tag.pending{background:#1e1b0b;color:#fde68a;border-color:#7c2d12}
    .grid{display:grid; gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .right{margin-left:auto}
    .small{font-size:12px}
    .statusline{display:flex;align-items:center;gap:10px;margin:8px 0 0 0}
    .dot{width:8px;height:8px;border-radius:50%;background:#64748b; display:inline-block}
    .dot.ok{background:var(--ok)} .dot.err{background:var(--err)}
    .hidden{display:none !important}
    .footer{margin-top:16px; font-size:12px; color:var(--text-dim); text-align:center}
    .kbd{border:1px solid var(--border); padding:0 6px; border-radius:6px; background:#0b1220; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    .danger{color:#fecaca}
    .success{color:#bbf7d0}
    .warn{color:#fde68a}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
  </style>
</head>
<body>
  <div class="container">

    <!-- HEADER -->
    <div class="row" style="align-items:center">
      <div class="col" style="flex: 1 1 100%">
        <h1>Admin Panel <span class="pill">Facebook Auto Comment Tool (Pro)</span></h1>
        <div class="muted">Login → Manage Users (approve / block / unblock / expire / delete)</div>
      </div>
    </div>

    <!-- LOGIN CARD -->
    <div id="loginCard" class="card" style="margin-top:16px;">
      <h2>Admin Login</h2>
      <div class="grid grid-2">
        <div>
          <label class="small muted">Username</label>
          <input class="input" id="username" placeholder="e.g. Bullet" value="Bullet"/>
        </div>
        <div>
          <label class="small muted">Password</label>
          <input class="input" id="password" type="password" placeholder="•••••" value="00000"/>
        </div>
      </div>
      <div class="toolbar" style="margin-top:12px">
        <button class="btn btn-primary" id="btnLogin">Sign In</button>
        <div class="statusline">
          <span id="loginDot" class="dot"></span>
          <span id="loginMsg" class="small muted">Use your admin credentials</span>
        </div>
      </div>
    </div>

    <!-- DASHBOARD CARD -->
    <div id="dashCard" class="card hidden" style="margin-top:16px;">
      <div class="toolbar">
        <h2 style="margin-right:8px">User Management</h2>
        <span id="authState" class="tag ok">Authenticated</span>
        <div class="right"></div>
        <input class="input" id="searchBox" placeholder="Search by sessionId / status…" style="max-width:280px"/>
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn btn-ghost" id="btnLogout">Logout</button>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <div class="grid grid-2">
            <div>
              <label class="small muted">Approve with Expiry</label>
              <input class="input" id="expiryInput" type="datetime-local"/>
              <div class="small muted" style="margin-top:4px">Leave empty for lifetime access</div>
            </div>
            <div>
              <label class="small muted">Quick Actions (selected rows)</label>
              <div class="toolbar" style="margin-top:6px; flex-wrap:wrap">
                <button class="btn btn-ok" id="bulkApprove">Approve</button>
                <button class="btn btn-warn" id="bulkBlock">Block</button>
                <button class="btn" id="bulkUnblock">Unblock</button>
                <button class="btn" id="bulkExpire">Set Expiry</button>
                <button class="btn btn-err" id="bulkDelete">Delete</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <table id="userTable">
        <thead>
        <tr>
          <th style="width:38px"><input type="checkbox" id="checkAll"/></th>
          <th>Session ID</th>
          <th>Status</th>
          <th>Blocked</th>
          <th>Expiry</th>
          <th>Approved At</th>
          <th>Updated</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody id="userTbody">
        <tr><td colspan="8" class="muted">No data</td></tr>
        </tbody>
      </table>

      <div class="statusline">
        <span id="dashDot" class="dot"></span>
        <span id="dashMsg" class="small muted">Ready</span>
      </div>

      <div class="footer">Tip: select rows with the left checkbox then use the bulk buttons. Reload with <span class="kbd">R</span>.</div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = ""; // same origin

    // ====== STATE ======
    let TOKEN = localStorage.getItem("admin_token") || "";
    const els = {
      loginCard: document.getElementById("loginCard"),
      dashCard: document.getElementById("dashCard"),
      username: document.getElementById("username"),
      password: document.getElementById("password"),
      btnLogin: document.getElementById("btnLogin"),
      loginMsg: document.getElementById("loginMsg"),
      loginDot: document.getElementById("loginDot"),
      authState: document.getElementById("authState"),
      btnLogout: document.getElementById("btnLogout"),
      btnRefresh: document.getElementById("btnRefresh"),
      searchBox: document.getElementById("searchBox"),
      userTbody: document.getElementById("userTbody"),
      checkAll: document.getElementById("checkAll"),
      expiryInput: document.getElementById("expiryInput"),
      bulkApprove: document.getElementById("bulkApprove"),
      bulkBlock: document.getElementById("bulkBlock"),
      bulkUnblock: document.getElementById("bulkUnblock"),
      bulkExpire: document.getElementById("bulkExpire"),
      bulkDelete: document.getElementById("bulkDelete"),
      dashMsg: document.getElementById("dashMsg"),
      dashDot: document.getElementById("dashDot"),
    };

    // ====== HELPERS ======
    function setLoginStatus(ok, msg){
      els.loginDot.className = "dot " + (ok ? "ok" : "err");
      els.loginMsg.textContent = msg || (ok ? "Authenticated" : "Authentication failed");
    }
    function setDashStatus(type, msg){
      els.dashDot.className = "dot " + (type || "");
      els.dashMsg.textContent = msg || "";
    }
    function fmtTime(ts){
      if (!ts) return "-";
      const d = new Date(Number(ts) || ts);
      return isNaN(d.getTime()) ? "-" : d.toLocaleString();
    }
    function badgeStatus(u){
      if (u.status === "approved" && !u.blocked) return '<span class="tag ok">approved</span>';
      if (u.status === "blocked" || u.blocked) return '<span class="tag block">blocked</span>';
      return '<span class="tag pending">pending</span>';
    }
    function withAuth(init={}){
      init.headers = Object.assign({}, init.headers || {}, {
        "Content-Type":"application/json",
        "Authorization":"Bearer " + TOKEN
      });
      return init;
    }
    async function api(path, opts){
      const res = await fetch(API_BASE + path, opts);
      if (res.status === 401){
        // token invalid
        logout(true);
        throw new Error("Unauthorized");
      }
      return res.json();
    }
    function show(view){
      if (view === "dash"){
        els.loginCard.classList.add("hidden");
        els.dashCard.classList.remove("hidden");
        els.authState.textContent = "Authenticated";
        els.authState.className = "tag ok";
      } else {
        els.dashCard.classList.add("hidden");
        els.loginCard.classList.remove("hidden");
      }
    }
    function selectedRows(){
      const checks = Array.from(document.querySelectorAll(".rowcheck:checked"));
      return checks.map(c => c.dataset.id);
    }

    // ====== LOGIN / LOGOUT ======
    async function login(){
      const username = els.username.value.trim();
      const password = els.password.value;
      els.btnLogin.disabled = true;
      setLoginStatus(false, "Signing in...");
      try{
        const data = await fetch(API_BASE + "/admin/login", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({username, password})
        }).then(r=>r.json());
        if (data.ok && data.token){
          TOKEN = data.token;
          localStorage.setItem("admin_token", TOKEN);
          setLoginStatus(true, "Login success");
          show("dash"); await loadUsers();
        } else {
          setLoginStatus(false, data.message || "Login failed");
        }
      }catch(e){
        setLoginStatus(false, e.message || "Network error");
      }finally{
        els.btnLogin.disabled = false;
      }
    }
    function logout(silent){
      TOKEN = "";
      localStorage.removeItem("admin_token");
      if (!silent) alert("Logged out");
      show("login");
    }

    // ====== USERS TABLE ======
    let USERS = [];
    async function loadUsers(){
      setDashStatus("", "Loading users...");
      try{
        const data = await api("/admin/users", withAuth());
        if (!data.ok) throw new Error("Failed to fetch users");
        USERS = data.users || [];
        renderUsers();
        setDashStatus("ok", `Loaded ${USERS.length} user(s)`);
      }catch(e){
        setDashStatus("err", e.message || "Failed");
      }
    }
    function renderUsers(){
      const q = (els.searchBox.value || "").toLowerCase();
      const rows = USERS
        .filter(u=>{
          if (!q) return true;
          return (
            (u.sessionId||"").toLowerCase().includes(q) ||
            (u.status||"").toLowerCase().includes(q)
          );
        })
        .map(u=>{
          const exp = u.expiry ? fmtTime(u.expiry) : "—";
          const appAt = u.approvedAt ? new Date(u.approvedAt).toLocaleString() : "—";
          const upd = u.updatedAt ? fmtTime(u.updatedAt) : "—";
          return `
            <tr>
              <td><input type="checkbox" class="rowcheck" data-id="${u.sessionId}"/></td>
              <td class="mono small">${u.sessionId}</td>
              <td>${badgeStatus(u)}</td>
              <td>${u.blocked ? '<span class="danger">true</span>' : '<span class="success">false</span>'}</td>
              <td class="small">${exp}</td>
              <td class="small">${appAt}</td>
              <td class="small">${upd}</td>
              <td>
                <div class="toolbar">
                  <button class="btn btn-ok" onclick="actApprove('${u.sessionId}')">Approve</button>
                  <button class="btn btn-warn" onclick="actBlock('${u.sessionId}')">Block</button>
                  <button class="btn" onclick="actUnblock('${u.sessionId}')">Unblock</button>
                  <button class="btn" onclick="actExpire('${u.sessionId}')">Set Expiry</button>
                  <button class="btn btn-err" onclick="actDelete('${u.sessionId}')">Delete</button>
                </div>
              </td>
            </tr>
          `;
        }).join("");
      els.userTbody.innerHTML = rows || `<tr><td colspan="8" class="muted">No users</td></tr>`;
      els.checkAll.checked = false;
    }

    // ====== ACTIONS (single) ======
    async function actApprove(id){
      const expiry = els.expiryInput.value ? new Date(els.expiryInput.value).toISOString() : null;
      setDashStatus("", `Approving ${id}...`);
      try{
        const data = await api("/admin/approve", withAuth({
          method:"POST",
          body: JSON.stringify({username:id, expiry})
        }));
        if (!data.ok) throw new Error(data.message || "Failed");
        await loadUsers();
        setDashStatus("ok", `Approved ${id}`);
      }catch(e){ setDashStatus("err", e.message || "Failed"); }
    }
    async function actBlock(id){
      setDashStatus("", `Blocking ${id}...`);
      try{
        const data = await api("/admin/block", withAuth({
          method:"POST",
          body: JSON.stringify({username:id})
        }));
        if (!data.ok) throw new Error(data.message || "Failed");
        await loadUsers();
        setDashStatus("ok", `Blocked ${id}`);
      }catch(e){ setDashStatus("err", e.message || "Failed"); }
    }
    async function actUnblock(id){
      setDashStatus("", `Unblocking ${id}...`);
      try{
        const data = await api("/admin/unblock", withAuth({
          method:"POST",
          body: JSON.stringify({username:id})
        }));
        if (!data.ok) throw new Error(data.message || "Failed");
        await loadUsers();
        setDashStatus("ok", `Unblocked ${id}`);
      }catch(e){ setDashStatus("err", e.message || "Failed"); }
    }
    async function actExpire(id){
      const expiry = els.expiryInput.value ? new Date(els.expiryInput.value).toISOString() : null;
      setDashStatus("", `Setting expiry for ${id}...`);
      try{
        const data = await api("/admin/expire", withAuth({
          method:"POST",
          body: JSON.stringify({username:id, expiry})
        }));
        if (!data.ok) throw new Error(data.message || "Failed");
        await loadUsers();
        setDashStatus("ok", `Expiry set for ${id}`);
      }catch(e){ setDashStatus("err", e.message || "Failed"); }
    }
    async function actDelete(id){
      if (!confirm(`Delete user ${id}?`)) return;
      setDashStatus("", `Deleting ${id}...`);
      try{
        const data = await api("/admin/delete", withAuth({
          method:"POST",
          body: JSON.stringify({username:id})
        }));
        if (!data.ok) throw new Error(data.message || "Failed");
        await loadUsers();
        setDashStatus("ok", `Deleted ${id}`);
      }catch(e){ setDashStatus("err", e.message || "Failed"); }
    }

    // expose for inline buttons
    window.actApprove = actApprove;
    window.actBlock = actBlock;
    window.actUnblock = actUnblock;
    window.actExpire = actExpire;
    window.actDelete = actDelete;

    // ====== BULK ACTIONS ======
    async function bulk(fnName){
      const ids = selectedRows();
      if (!ids.length){ alert("Select at least one row"); return; }
      if (fnName === "delete" && !confirm(`Delete ${ids.length} user(s)?`)) return;

      for (let id of ids){
        if (fnName === "approve") await actApprove(id);
        else if (fnName === "block") await actBlock(id);
        else if (fnName === "unblock") await actUnblock(id);
        else if (fnName === "expire") await actExpire(id);
        else if (fnName === "delete") await actDelete(id);
      }
    }

    // ====== EVENTS ======
    els.btnLogin.addEventListener("click", login);
    els.btnRefresh.addEventListener("click", loadUsers);
    els.btnLogout.addEventListener("click", ()=>logout(false));
    els.searchBox.addEventListener("input", renderUsers);
    els.checkAll.addEventListener("change", (e)=>{
      const v = e.target.checked;
      document.querySelectorAll(".rowcheck").forEach(ch => ch.checked = v);
    });
    els.bulkApprove.addEventListener("click", ()=>bulk("approve"));
    els.bulkBlock.addEventListener("click", ()=>bulk("block"));
    els.bulkUnblock.addEventListener("click", ()=>bulk("unblock"));
    els.bulkExpire.addEventListener("click", ()=>bulk("expire"));
    els.bulkDelete.addEventListener("click", ()=>bulk("delete"));

    // keyboard: R to refresh
    window.addEventListener("keydown",(e)=>{
      if (e.key.toLowerCase()==="r" && !e.metaKey && !e.ctrlKey){
        e.preventDefault(); loadUsers();
      }
    });

    // ====== BOOT ======
    (async function init(){
      if (TOKEN){
        try{
          show("dash");
          await loadUsers();
          setLoginStatus(true,"Session restored");
        }catch{
          logout(true);
          setLoginStatus(false,"Session expired");
        }
      } else {
        show("login");
      }
    })();
  </script>
</body>
</html>
