<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">⚙️ Admin Panel</h1>

    <!-- Stats -->
    <div class="grid grid-cols-3 gap-4 mb-6" id="stats">
      <div class="bg-white p-4 rounded shadow text-center">
        <h2 class="text-lg font-bold">Pending</h2>
        <p id="pending-count" class="text-2xl text-yellow-600">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <h2 class="text-lg font-bold">Approved</h2>
        <p id="approved-count" class="text-2xl text-green-600">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <h2 class="text-lg font-bold">Blocked</h2>
        <p id="blocked-count" class="text-2xl text-red-600">0</p>
      </div>
    </div>

    <!-- Users Table -->
    <div class="bg-white p-4 rounded shadow mb-6">
      <h2 class="text-xl font-bold mb-4">Users</h2>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-200">
            <th class="border p-2">Username</th>
            <th class="border p-2">Status</th>
            <th class="border p-2">Expiry</th>
            <th class="border p-2">Actions</th>
          </tr>
        </thead>
        <tbody id="users-table"></tbody>
      </table>
    </div>

    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
  </div>

  <!-- Approve Modal -->
  <div id="approve-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-96">
      <h2 class="text-lg font-bold mb-4">Approve User</h2>
      <p id="approve-username" class="mb-4 font-mono text-blue-600"></p>
      
      <label class="block mb-2">Select Access Type:</label>
      <select id="approve-type" class="w-full border p-2 rounded">
        <option value="lifetime">Lifetime</option>
        <option value="7">7 Days</option>
        <option value="30">30 Days</option>
        <option value="90">90 Days</option>
      </select>
      
      <div class="flex justify-end mt-4">
        <button onclick="closeModal()" class="bg-gray-400 px-3 py-1 rounded mr-2">Cancel</button>
        <button onclick="confirmApprove()" class="bg-green-500 px-3 py-1 text-white rounded">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "/admin";
    let approveTarget = null;

    async function refreshData() {
      // Counts
      let countsRes = await fetch(API_BASE + "/counts");
      let countsData = await countsRes.json();
      if (countsData.success) {
        document.getElementById("pending-count").innerText = countsData.counts.pending;
        document.getElementById("approved-count").innerText = countsData.counts.approved;
        document.getElementById("blocked-count").innerText = countsData.counts.blocked;
      }

      // Users
      let res = await fetch(API_BASE + "/users");
      let data = await res.json();
      if (data.success) {
        let html = "";
        data.users.forEach(u => {
          html += `
            <tr>
              <td class="border p-2">${u.username}</td>
              <td class="border p-2">${u.blocked ? "Blocked" : (u.approvedAt ? "Approved" : "Pending")}</td>
              <td class="border p-2">${u.expiry ? new Date(u.expiry).toLocaleDateString() : "Lifetime"}</td>
              <td class="border p-2">
                ${u.blocked 
                  ? `<button onclick="unblockUser('${u.username}')" class="bg-green-500 text-white px-2 py-1 rounded">Unblock</button>` 
                  : `<button onclick="openApproveModal('${u.username}')" class="bg-blue-500 text-white px-2 py-1 rounded">Approve</button>
                     <button onclick="blockUser('${u.username}')" class="bg-red-500 text-white px-2 py-1 rounded">Block</button>`}
              </td>
            </tr>
          `;
        });
        document.getElementById("users-table").innerHTML = html;
      }
    }

    function openApproveModal(username) {
      approveTarget = username;
      document.getElementById("approve-username").innerText = username;
      document.getElementById("approve-modal").classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("approve-modal").classList.add("hidden");
      approveTarget = null;
    }

    async function confirmApprove() {
      let type = document.getElementById("approve-type").value;
      let expiry = null;

      if (type !== "lifetime") {
        let days = parseInt(type);
        let date = new Date();
        date.setDate(date.getDate() + days);
        expiry = date.toISOString();
      }

      await fetch(API_BASE + "/approve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: approveTarget, expiry })
      });

      closeModal();
      refreshData();
    }

    async function blockUser(username) {
      await fetch(API_BASE + "/block", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: username })
      });
      refreshData();
    }

    async function unblockUser(username) {
      await fetch(API_BASE + "/approve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: username })
      });
      refreshData();
    }

    function logout() {
      localStorage.removeItem("adminToken");
      window.location.href = "/login.html";
    }

    refreshData();
  </script>
</body>
</html>
