<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Logs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --card:#0f1626; --fg:#e5e7eb; --muted:#9aa4b2; --primary:#2563eb; --ok:#16a34a; --err:#ef4444; --warn:#eab308; }
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:920px;margin:0 auto;padding:12px}
    .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .bar button{background:var(--primary);border:0;color:#fff;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
    .bar .danger{background:var(--err)}
    .bar .ghost{background:#1f2937}
    .chip{padding:6px 10px;border-radius:1000px;background:#1f2535;color:#cbd5e1;font-size:12px}
    .panel{background:var(--card);border:1px solid #1e293b;border-radius:12px;overflow:hidden}
    .panel h3{margin:0;padding:10px 12px;background:#111827}
    .logs{height:52vh;overflow:auto;font-family:ui-monospace,Consolas,monaco,monospace;font-size:13px;padding:10px 12px}
    .line{padding:2px 0;white-space:pre-wrap;word-break:break-word}
    .line.ok{color:var(--ok)}
    .line.err{color:var(--err)}
    .line.warn{color:var(--warn)}
    .muted{color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:800px){ .split{grid-template-columns:1fr} .logs{height:46vh} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <button id="llStart">▶ Start</button>
      <button id="llStop"  class="danger">■ Stop</button>
      <label class="chip"><input id="llAuto" type="checkbox" checked style="margin-right:6px">Auto-scroll</label>
      <span class="chip">User: <b id="llUser" class="muted">loading…</b></span>
      <span class="chip">Status: <b id="llStatus" class="muted">—</b></span>
      <span class="chip">Expiry: <b id="llExpiry" class="muted">∞</b></span>
    </div>

    <div class="split">
      <div class="panel">
        <h3>Live Log</h3>
        <div id="llLog" class="logs" aria-live="polite"></div>
      </div>
      <div class="panel">
        <h3>Warnings & Summary</h3>
        <div id="llWarn" class="logs" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    let sessionId = null;
    let es = null;
    const el = (id)=>document.getElementById(id);
    const boxLog  = el('llLog');
    const boxWarn = el('llWarn');
    const auto    = el('llAuto');

    const add = (box, cls, text) => {
      const d = document.createElement('div');
      d.className = 'line ' + (cls||'');
      const ts = new Date().toLocaleTimeString();
      d.textContent = `[${ts}] ${text}`;
      box.appendChild(d);
      if (auto.checked) box.scrollTop = box.scrollHeight;
    };
    const info = (t)=>add(boxLog,'',t);
    const ok   = (t)=>add(boxLog,'ok',t);
    const warn = (t)=>add(boxWarn,'warn',t);
    const err  = (t)=>add(boxWarn,'err',t);

    // load session
    fetch('/session', {credentials:'include'})
      .then(r=>r.json())
      .then(j=>{
        sessionId = j.id;
        el('llUser').textContent = sessionId;
        el('llStatus').textContent = j.status || '-';
        el('llExpiry').textContent = j.expiry ? new Date(+j.expiry).toLocaleString() : '∞';
        connectSSE();
      })
      .catch(e=>err('Session error: '+e.message));

    function connectSSE(){
      if (!sessionId) return;
      if (es) es.close();
      es = new EventSource(`/events?sessionId=${encodeURIComponent(sessionId)}`);

      es.addEventListener('user', (e)=>{
        try{
          const u = JSON.parse(e.data||'{}');
          el('llStatus').textContent = u.status || '-';
          el('llExpiry').textContent = u.expiry ? new Date(+u.expiry).toLocaleString() : '∞';
          info(`👤 ${u.status}${u.blocked?' (blocked)':''}${u.expiry?`, expiry ${new Date(+u.expiry).toLocaleString()}`:''}`);
        }catch{}
      });

      es.onmessage = (e)=>{
        try{
          const d = JSON.parse(e.data||'{}');
          const t = (d.text||'').toString();
          const type = (d.type||'log').toLowerCase();

          if (type==='ready') { info('🔗 Connected'); return; }
          if (type==='summary'){
            ok(`📊 Summary: sent=${d.sent ?? '-'}, ok=${d.ok ?? '-'}, failed=${d.failed ?? '-'}`);
            return;
          }
          if (type==='error'){ err(t); return; }
          if (type==='warn'){ warn(t); return; }
          if (/^✔ /.test(t) || type==='success'){ ok(t); return; }
          info(t);
        }catch(ex){
          err('Parse error: '+ex.message);
        }
      };

      es.onerror = ()=>{
        err('⚠ SSE connection lost. Reconnecting soon…');
        es && es.close();
        setTimeout(connectSSE, 2000);
      };
    }

    // Start from popup (uses minimal defaults; respects your server)
    el('llStart').addEventListener('click', async ()=>{
      try{
        info('Sending start…');
        const res = await fetch('/start', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({
            sessionId,
            delay: 20,          // UI default delay (sec)
            limit: 0,           // unlimited
            shuffle: false,
            speedMode: 'fast',  // user main UI না থাকলে safe default
            posts: []           // main UI থেকে সেট না থাকলে server-side uploads ব্যবহার হবে
          })
        });
        const j = await res.json();
        if (j.ok) ok('✅ Started'); else err('Start failed: '+(j.message||j.error||'Unknown'));
      }catch(e){ err('Start error: '+e.message); }
    });

    // Stop current session job
    el('llStop').addEventListener('click', async ()=>{
      try{
        info('Sending stop…');
        const res = await fetch('/stop', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ sessionId })
        });
        const j = await res.json();
        if (j.ok) ok('🛑 Stop requested'); else warn('Stop: '+(j.message||'No active job'));
      }catch(e){ err('Stop error: '+e.message); }
    });
  })();
  </script>
</body>
</html>
